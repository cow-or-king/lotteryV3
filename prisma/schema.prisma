// ReviewLottery v3.0 - Database Schema
// Architecture: Hexagonal / DDD
// IMPORTANT: ZERO compromis sur la type-safety

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================
// USERS & AUTHENTICATION
// =====================

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  emailVerified  Boolean  @default(false) @map("email_verified")
  hashedPassword String?  @map("hashed_password")
  name           String?
  avatarUrl      String?  @map("avatar_url")
  role           String   @default("ADMIN") // "USER" | "ADMIN" | "SUPER_ADMIN"
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  subscription     Subscription?
  brands           Brand[]
  prizeTemplates   PrizeTemplate[]
  reviewsResponded Review[]

  @@index([email])
  @@map("users")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique @map("user_id")
  plan                 String    @default("FREE")
  status               String    @default("ACTIVE")
  storesLimit          Int       @default(1) @map("stores_limit")
  campaignsLimit       Int       @default(0) @map("campaigns_limit")
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// =====================
// BRANDS (Enseignes)
// =====================

model Brand {
  id             String   @id @default(cuid())
  name           String
  logoUrl        String   @map("logo_url")
  ownerId        String   @map("owner_id")
  primaryColor   String   @default("#5B21B6") @map("primary_color")
  secondaryColor String   @default("#FACC15") @map("secondary_color")
  font           String   @default("inter")
  isPaid         Boolean  @default(false) @map("is_paid") // true si c'est une enseigne payante (2ème+)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  stores         Store[]
  prizeTemplates PrizeTemplate[]
  prizeSets      PrizeSet[]

  @@index([ownerId])
  @@index([ownerId, createdAt(sort: Desc)])
  @@map("brands")
}

// =====================
// STORES (Commerces)
// =====================

model Store {
  id                 String    @id @default(cuid())
  slug               String    @unique
  brandId            String    @map("brand_id")
  name               String
  description        String?
  googlePlaceId      String?   @map("google_place_id")
  googleBusinessUrl  String    @map("google_business_url")
  googlePlacesApiKey String?   @map("google_places_api_key") // CHIFFRÉ AES-256-GCM
  googleApiKeyStatus String?   @default("not_configured") @map("google_api_key_status")
  lastReviewSync     DateTime? @map("last_review_sync")
  autoSyncEnabled    Boolean   @default(false) @map("auto_sync_enabled")
  syncFrequencyHours Int       @default(24) @map("sync_frequency_hours")
  isActive           Boolean   @default(true) @map("is_active")
  isPaid             Boolean   @default(false) @map("is_paid") // true si c'est un commerce payant (2ème+)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  brand             Brand              @relation(fields: [brandId], references: [id], onDelete: Cascade)
  campaigns         Campaign[]
  reviews           Review[]
  responseTemplates ResponseTemplate[]

  @@index([brandId])
  @@index([brandId, createdAt(sort: Desc)])
  @@index([slug])
  @@map("stores")
}

// =====================
// CAMPAIGNS
// =====================

model Campaign {
  id               String   @id @default(cuid())
  name             String
  description      String?
  storeId          String   @map("store_id")
  startDate        DateTime @map("start_date")
  endDate          DateTime @map("end_date")
  isActive         Boolean  @default(false) @map("is_active")
  wheelStyle       String   @default("classic") @map("wheel_style")
  wheelAnimation   String   @default("spin") @map("wheel_animation")
  type             String   @default("generic") // "review" | "social" | "generic"
  requireReview    Boolean  @default(false) @map("require_review")
  requireInstagram Boolean  @default(false) @map("require_instagram") // future
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  prizes       Prize[]
  participants Participant[]
  reviews      Review[]

  @@index([storeId])
  @@index([isActive, startDate, endDate])
  @@map("campaigns")
}

// =====================
// PRIZES
// =====================

model Prize {
  id          String   @id @default(cuid())
  name        String
  description String?
  value       Float?
  campaignId  String   @map("campaign_id")
  color       String
  probability Float
  quantity    Int
  remaining   Int
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  winners  Winner[]

  @@index([campaignId])
  @@map("prizes")
}

// =====================
// PARTICIPANTS
// =====================

model Participant {
  id                 String    @id @default(cuid())
  email              String
  name               String?
  phone              String?
  campaignId         String    @map("campaign_id")
  hasPlayed          Boolean   @default(false) @map("has_played")
  playedAt           DateTime? @map("played_at")
  ipAddress          String?   @map("ip_address")
  userAgent          String?   @map("user_agent")
  hasReviewed        Boolean   @default(false) @map("has_reviewed")
  reviewRating       Int?      @map("review_rating")
  reviewComment      String?   @map("review_comment")
  consentDate        DateTime? @map("consent_date")
  dataRetentionUntil DateTime? @map("data_retention_until") // 3 ans après dernière interaction
  createdAt          DateTime  @default(now()) @map("created_at")

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  review   Review?

  @@unique([email, campaignId])
  @@index([campaignId])
  @@index([email])
  @@index([dataRetentionUntil])
  @@map("participants")
}

// =====================
// WINNERS
// =====================

model Winner {
  id               String    @id @default(cuid())
  prizeId          String    @map("prize_id")
  participantEmail String    @map("participant_email")
  participantName  String?   @map("participant_name")
  claimCode        String    @unique @map("claim_code")
  status           String    @default("PENDING")
  claimedAt        DateTime? @map("claimed_at")
  expiresAt        DateTime  @map("expires_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  prize Prize @relation(fields: [prizeId], references: [id], onDelete: Cascade)

  @@index([claimCode])
  @@index([status])
  @@map("winners")
}

// =====================
// GOOGLE REVIEWS
// =====================

model Review {
  id              String    @id @default(cuid())
  googleReviewId  String    @unique @map("google_review_id")
  storeId         String    @map("store_id")
  campaignId      String?   @map("campaign_id")
  authorName      String    @map("author_name")
  authorEmail     String?   @map("author_email")
  authorGoogleId  String?   @map("author_google_id")
  authorPhotoUrl  String?   @map("author_photo_url")
  rating          Int // 1-5
  comment         String?   @db.Text
  publishedAt     DateTime  @map("published_at")
  hasResponse     Boolean   @default(false) @map("has_response")
  responseContent String?   @map("response_content") @db.Text
  respondedAt     DateTime? @map("responded_at")
  respondedBy     String?   @map("responded_by")
  isVerified      Boolean   @default(false) @map("is_verified")
  participantId   String?   @unique @map("participant_id")
  aiSuggestion    Json?     @map("ai_suggestion")
  aiSentiment     String?   @map("ai_sentiment")
  reviewUrl       String    @map("review_url")
  googlePlaceId   String    @map("google_place_id")
  photoUrl        String?   @map("photo_url")
  status          String    @default("NEW")
  sentiment       String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  campaign    Campaign?    @relation(fields: [campaignId], references: [id])
  participant Participant? @relation(fields: [participantId], references: [id])
  respondent  User?        @relation(fields: [respondedBy], references: [id])

  @@index([storeId, publishedAt])
  @@index([campaignId])
  @@index([authorEmail, storeId])
  @@index([isVerified])
  @@index([rating])
  @@index([storeId, status])
  @@map("reviews")
}

// =====================
// RESPONSE TEMPLATES
// =====================

model ResponseTemplate {
  id         String   @id @default(cuid())
  storeId    String   @map("store_id")
  name       String
  content    String   @db.Text
  category   String // "positive" | "neutral" | "negative"
  usageCount Int      @default(0) @map("usage_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([storeId, category])
  @@map("response_templates")
}

// =====================
// PRIZE TEMPLATES (Gains réutilisables)
// =====================

model PrizeTemplate {
  id          String   @id @default(cuid())
  brandId     String?  @map("brand_id") // null = gain commun à toutes les enseignes
  ownerId     String   @map("owner_id") // Propriétaire du gain
  name        String // "Café offert", "-10% sur votre commande"
  description String?
  minPrice    Float?   @map("min_price") // Prix minimum (optionnel)
  maxPrice    Float?   @map("max_price") // Prix maximum (optionnel)
  color       String   @default("#8B5CF6") // Couleur par défaut
  iconUrl     String?  @map("icon_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner     User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  brand     Brand?         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  prizeSets PrizeSetItem[]

  @@index([brandId])
  @@index([ownerId])
  @@index([brandId, createdAt(sort: Desc)])
  @@index([ownerId, createdAt(sort: Desc)])
  @@map("prize_templates")
}

// =====================
// PRIZE SETS (Lots de gains)
// =====================

model PrizeSet {
  id          String   @id @default(cuid())
  brandId     String   @map("brand_id")
  name        String // "Lot Café", "Lot Printemps"
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  brand Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  items PrizeSetItem[]

  @@index([brandId])
  @@index([brandId, createdAt(sort: Desc)])
  @@map("prize_sets")
}

// =====================
// PRIZE SET ITEMS (Table de liaison)
// =====================

model PrizeSetItem {
  id              String   @id @default(cuid())
  prizeSetId      String   @map("prize_set_id")
  prizeTemplateId String   @map("prize_template_id")
  probability     Float    @default(10) // Probabilité par défaut (%)
  quantity        Int      @default(1) // Quantité par défaut
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  prizeSet      PrizeSet      @relation(fields: [prizeSetId], references: [id], onDelete: Cascade)
  prizeTemplate PrizeTemplate @relation(fields: [prizeTemplateId], references: [id], onDelete: Cascade)

  @@unique([prizeSetId, prizeTemplateId])
  @@index([prizeSetId])
  @@index([prizeTemplateId])
  @@map("prize_set_items")
}

// =====================
// PLAN LIMITS (Configuration des limites)
// =====================

model PlanLimits {
  id   String @id @default(cuid())
  plan String @unique // FREE, STARTER, PRO

  // Limites Brands & Stores
  maxBrands         Int @map("max_brands")
  maxStoresPerBrand Int @map("max_stores_per_brand")

  // Limites Prizes & PrizeSets
  maxPrizeTemplates Int @map("max_prize_templates")
  maxPrizeSets      Int @map("max_prize_sets")

  // Limites Campaigns
  maxCampaigns    Int @map("max_campaigns")
  maxParticipants Int @map("max_participants")

  // Features activées
  customBranding     Boolean @default(false) @map("custom_branding")
  advancedAnalytics  Boolean @default(false) @map("advanced_analytics")
  apiAccess          Boolean @default(false) @map("api_access")
  prioritySupport    Boolean @default(false) @map("priority_support")
  aiResponsesEnabled Boolean @default(false) @map("ai_responses_enabled")

  // AI Limits
  aiResponsesPerMonth Int? @map("ai_responses_per_month") // null = illimité

  // Pricing
  priceMonthly Float?  @map("price_monthly")
  priceYearly  Float?  @map("price_yearly")
  description  String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([plan])
  @@map("plan_limits")
}

// =====================
// AI SERVICE CONFIG (Super-Admin uniquement)
// =====================

model AiServiceConfig {
  id       String @id @default(cuid())
  provider String // "openai" | "anthropic"

  // API Keys (CHIFFRÉES AES-256-GCM)
  apiKey       String @map("api_key") @db.Text
  apiKeyStatus String @default("active") @map("api_key_status") // "active" | "inactive" | "error"

  // Configuration
  model        String  @default("gpt-4") // "gpt-4" | "claude-3-opus" | "claude-3-sonnet"
  maxTokens    Int     @default(500) @map("max_tokens")
  temperature  Float   @default(0.7)
  systemPrompt String? @map("system_prompt") @db.Text

  // Monitoring
  isActive           Boolean   @default(true) @map("is_active")
  dailyQuotaLimit    Int?      @map("daily_quota_limit") // Limite quotidienne globale
  lastUsedAt         DateTime? @map("last_used_at")
  totalRequestsCount Int       @default(0) @map("total_requests_count")
  totalTokensUsed    Int       @default(0) @map("total_tokens_used")
  lastErrorAt        DateTime? @map("last_error_at")
  lastErrorMessage   String?   @map("last_error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([provider])
  @@index([isActive])
  @@map("ai_service_config")
}

// =====================
// AI USAGE LOG (Facturation clients)
// =====================

model AiUsageLog {
  id       String  @id @default(cuid())
  userId   String  @map("user_id") // Admin qui a utilisé l'IA
  storeId  String? @map("store_id") // Commerce concerné (optionnel)
  reviewId String? @map("review_id") // Avis concerné (optionnel)

  // Details de la requête
  provider         String // "openai" | "anthropic"
  model            String // "gpt-4" | "claude-3-opus"
  promptTokens     Int    @map("prompt_tokens")
  completionTokens Int    @map("completion_tokens")
  totalTokens      Int    @map("total_tokens")

  // Coût estimé (pour facturation)
  estimatedCostUsd Float @map("estimated_cost_usd")

  // Métadonnées
  requestType String  @map("request_type") // "generate_response" | "sentiment_analysis"
  wasUsed     Boolean @default(false) @map("was_used") // L'utilisateur a-t-il utilisé la suggestion ?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([storeId, createdAt])
  @@index([reviewId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}
